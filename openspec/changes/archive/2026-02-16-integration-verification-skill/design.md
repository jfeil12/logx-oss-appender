## Context

当前变更的目标是把“代码完成后必须进行完整集成验证”从约定升级为可执行、可审计的工程门禁。仓库已具备真实 MinIO 与兼容性测试基础能力（如 `compatibility-tests/`、MinIO 启动脚本与相关测试文档），但缺少统一入口、统一判定标准和失败阻断机制，导致验证执行不一致。

约束与边界如下：
- 必须基于真实 MinIO 环境进行验证，不能用 mock 替代门禁。
- 门禁需要覆盖项目要求的全量集成链路，并以“失败即未完成”作为硬标准。
- 本地与 CI 需要采用一致的验证语义，避免“本地通过/CI失败”或“CI通过/本地不可复现”。

关键相关方：功能开发者、代码评审者、CI 维护者。

## Goals / Non-Goals

**Goals:**
- 建立统一的“编码完成后验证”入口（技能/命令驱动），减少人为遗漏。
- 明确真实 MinIO 环境前置检查、全量测试执行顺序、失败退出语义。
- 固化可审计输出（执行日志、失败定位信息、通过判定），支撑评审与回归。
- 使“通过完整集成验证”成为变更完成定义的一部分。

**Non-Goals:**
- 不重构日志生产与上传核心实现（`logx-producer`、适配器核心逻辑不在本设计范围）。
- 不替代单元测试体系，也不把所有测试统一成同一阶段执行。
- 不新增存储后端能力（本变更聚焦验证流程，而非存储协议扩展）。

## Decisions

1. **决策：采用技能化统一入口触发集成验证（以现有 MinIO 验证技能为核心）**
   - 原因：统一入口可减少执行分叉，便于在本地与 CI 复用同一流程语义。
   - 备选方案：
     - 方案A：仅在文档中列出手工命令。
     - 放弃原因：可执行性弱，易遗漏，难以形成稳定门禁。

2. **决策：门禁范围使用“项目要求的全量链路”而非抽样测试**
   - 原因：变更目标是“完成定义”，必须以完整链路保证可靠性，避免抽样漏检。
   - 备选方案：
     - 方案A：仅运行 smoke 测试或部分模块。
     - 放弃原因：无法覆盖跨模块兼容性与真实环境问题，不能作为交付门槛。

3. **决策：真实 MinIO 作为强前置依赖，验证前执行环境就绪检查**
   - 原因：提前失败可减少无效测试耗时，并提高失败定位效率。
   - 备选方案：
     - 方案A：依赖 mock/S3 仿真环境。
     - 放弃原因：与真实对象存储行为存在偏差，不满足本项目对真实链路验证的要求。

4. **决策：采用严格失败语义（任一步骤失败即整体失败）并输出结构化结果**
   - 原因：门禁必须具有阻断性，且结果可追踪，避免“带病通过”。
   - 备选方案：
     - 方案A：失败仅告警，不阻断。
     - 放弃原因：无法形成有效质量门槛，与本次变更目标冲突。

5. **决策：本地与 CI 共享同一命令契约，差异仅体现在运行环境注入**
   - 原因：降低环境差异导致的误报，提升可复现性。
   - 备选方案：
     - 方案A：本地与 CI 维护两套独立流程。
     - 放弃原因：维护成本高，语义容易漂移，问题定位复杂。

## Risks / Trade-offs

- [风险] 真实 MinIO 环境不稳定导致误失败 → [缓解] 增加健康检查、重试与启动诊断输出，失败时给出明确故障定位信息。
- [风险] 全量集成验证耗时上升影响开发反馈速度 → [缓解] 先执行快速前置检查，必要时在开发阶段提供“快速预检 + 完整门禁”分层策略，但合并前必须跑完整门禁。
- [风险] 本地环境准备门槛较高（MinIO、端口、凭据） → [缓解] 复用并强化一键启动脚本与标准环境变量模板，提供最小化操作指南。
- [风险] 多模块链路失败时定位成本高 → [缓解] 统一输出日志目录、失败模块和关键命令，确保可快速复现。

## Migration Plan

1. 在 specs 中定义能力要求：
   - 编码完成后必须触发统一验证入口。
   - 真实 MinIO 前置检查与全量链路通过标准。
2. 在实现阶段落地命令编排与失败语义：
   - 固化执行顺序（环境检查 → 全量测试 → 结果汇总）。
   - 确保非零退出码阻断后续流程。
3. 在 CI 中接入并设为必过门禁：
   - 将验证结果作为合并前置条件。
4. 回滚策略：
   - 若门禁引发阻塞，可临时降级为“人工放行 + 必须附验证记录”的应急模式；
   - 问题修复后恢复强制门禁，避免长期弱化质量标准。

## Open Questions

- 门禁统一命令是否固定为 `/minio-verify`，还是允许 `/integration-verify` 作为别名入口。
- “项目要求的全量链路”最终清单是否固定包含所有 compatibility-tests 模块与 `jdk21-test`。
- 本地开发流程是否允许先跑快速预检，再在提交/合并前强制全量验证。
- 失败报告是否需要标准化格式（如固定摘要字段与日志路径规范）以便自动解析。
